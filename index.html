<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kid Tracker Live Map with Geofence</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    .leaflet-popup-content { font-size: 14px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Default location ‚Äî Leon, Iloilo (home base)
    const homeLat = 10.8264;
    const homeLng = 122.3716;
    const GEOFENCE_RADIUS = 50; // meters

    // Initialize map
    const map = L.map('map').setView([homeLat, homeLng], 17);

    // üó∫Ô∏è Add base map
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // üè† Add home marker
    const homeMarker = L.marker([homeLat, homeLng])
      .addTo(map)
      .bindPopup("üè† Home Base (Leon, Iloilo)");

    // üöß Create geofence circle (50 m radius)
    const fence = L.circle([homeLat, homeLng], {
      color: "green",
      fillColor: "#a0f3a0",
      fillOpacity: 0.3,
      radius: GEOFENCE_RADIUS
    }).addTo(map);

    // üíô Blue pin icon for Arduino Nano tracker
    const kidIcon = L.icon({
      iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png",
      shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png",
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    // üéí Kid marker (Arduino tracker)
    const kidMarker = L.marker([homeLat, homeLng], { icon: kidIcon })
      .addTo(map)
      .bindPopup("üéí Arduino Nano Tracker<br>Waiting for GPS data...");

    // üî¥ Parent marker (your device)
    const parentMarker = L.circleMarker([homeLat, homeLng], {
      radius: 8,
      fillColor: "#ff0000",
      color: "#fff",
      weight: 2,
      opacity: 1,
      fillOpacity: 0.9
    }).addTo(map).bindPopup("üìç You are here (Parent)");

    // üß≠ Track parent‚Äôs current location (device)
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          parentMarker.setLatLng([lat, lng]);
        },
        (err) => console.warn("Geolocation error:", err.message),
        { enableHighAccuracy: true }
      );
    }

    // üìè Helper function: compute distance in meters using Haversine formula
    function distanceMeters(lat1, lng1, lat2, lng2) {
      const R = 6371000; // Earth radius (m)
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // üö® Check if the kid is inside or outside the geofence
    function checkGeofence(lat, lng) {
      const dist = distanceMeters(homeLat, homeLng, lat, lng);
      const inside = dist <= GEOFENCE_RADIUS;

      if (inside) {
        fence.setStyle({ color: "green", fillColor: "#a0f3a0" });
      } else {
        fence.setStyle({ color: "red", fillColor: "#f3a0a0" });
        alert(`‚ö†Ô∏è ALERT: The child has left the 50 m safe zone!\nDistance: ${dist.toFixed(1)} m`);
      }
    }

    // üîÑ Fetch and update kid‚Äôs tracker position
    async function updateKidTracker() {
      try {
        const res = await fetch('locations.csv?_=' + Date.now());
        const text = await res.text();
        const lines = text.trim().split('\n');
        if (lines.length < 2) return;
        const last = lines.pop().split(',');
        const lat = parseFloat(last[1]);
        const lng = parseFloat(last[2]);

        if (!isNaN(lat) && !isNaN(lng)) {
          kidMarker.setLatLng([lat, lng]);
          kidMarker.bindPopup(`üéí Arduino Tracker<br>Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}`);
          checkGeofence(lat, lng);
        }
      } catch (err) {
        console.error("Error updating tracker:", err);
      }
    }

    // Refresh every 5 seconds
    setInterval(updateKidTracker, 2000);
  </script>
</body>
</html>
